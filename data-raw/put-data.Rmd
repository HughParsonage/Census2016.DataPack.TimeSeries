

```{r Region}
Region <- "STE"
```

```{r setup}
START <- Sys.time()
knitr::opts_knit$set(root.dir = "..")
knitr::opts_chunk$set(echo = TRUE, 
                      print_chunk = TRUE)
```

```{r loadPackages}
library(readxl)
library(testthat)
library(magrittr)
library(hutils)
library(data.table)
library(ASGS)
library(Census2016.DataPack)
```


```{r Clear-tables}
# Ensure we are working with pristine tables
if (!isTRUE(getOption("knitr.in.progress"))) {
  AllTables <- Filter(function(x) is.data.table(get(x)), ls())
  if (length(AllTables) != 0) {
    if (exists("table_killer")) {
      menu_selection <- 1
    } else {
      menu_selection <- menu(c("Remove all tables.",
                               "Cancel."),
                             title = "Data tables detected. This script will save all tables in the workspace to the package. Remove current tables from workspace?")
    }
  }
  
  if (exists("menu_selection")) {
    if (menu_selection %in% c(0, 2)) {
      stop("Operation cancelled.")
    } else {
      rm(list = AllTables)
    }
  }
}
```

```{r rename-decoder}
if (!isNamespaceLoaded("Census2016.DataPack")) {
  load("../data/SA16_decoder.rda")
}
```

```{r Metadata}
Metadata <-
  read_excel("./data-raw/Metadata/Metadata_2016_TSP_DataPack.xlsx",
             sheet = "Cell descriptors information", 
             skip = 12) %>%
  as.data.table %>%
  .[, varI := as.integer(gsub("^T", "", Sequential))] %>%
  setnames("DataPack file", "DataPackFile") %>%
  .[, TableNo := as.integer(gsub("[^0-9]", "", DataPackFile))] %>%
  .[]
```

```{r short2long}
.short2long <- function(short) {
  coalesce(Metadata[match(x = short, Short)][["Long"]], short)
}

expect_equal(.short2long(c("squierl", "Tot_persons_C11_F", "Tot_C16_P")),
             c("squierl", 
               "Total_persons_2011_Census_Females",
               "Total_2016_Census_Persons"))

short2long <- function(.data) {
  noms <- names(.data)
  setnames(.data, noms, .short2long(noms))
}
```

```{r Region_key}
Region_key <- 
  fread(paste0('./data-raw/data/', Region, '/AUST/2016Census_T01_AUS_', Region, '.csv')) %>%
  names %>%
  extract2(1)
```

```{r perf}
grep <- function(..., perl, fixed) base::grep(..., perl = missing(fixed), fixed = !missing(fixed))
grepl <- function(..., perl, fixed) base::grepl(..., perl = missing(fixed), fixed = !missing(fixed))
gsub <- function(..., perl, fixed) base::gsub(..., perl = missing(fixed), fixed = !missing(fixed))
sub <- function(..., perl, fixed) base::sub(..., perl = missing(fixed), fixed = !missing(fixed))
```

```{r freadG}
#' @return Wide as-is data table of all tables.
freadG <- function(g, ...) {
  stopifnot(length(g) == 1)
  g0 <- paste0(if (g < 10) "0", g)
  file_list <-
    list.files(path = file.path('./data-raw/data/', Region, 'AUST'),
               # Files may be of the form ..G08_AUS.. or ..G09B_AUS..
               pattern = paste0('2016Census_T', g0, '[A-Z]?_AUS_', Region, '\\.csv$'),
               full.names = TRUE)
  if (length(file_list) > 1) {
    file_list %>%
    lapply(fread, key = Region_key, ...) %>%
    Reduce(f = function(X, Y) X[Y])
  } else {
    fread(file = file_list[1], ...)
  } %>% 
    short2long
}
```

```{r freadT}
freadT <- function(g, vi = NULL, value.name = "persons") {
  gmolten <- 
    freadG(g) %>%
    melt.data.table(id.vars = Region_key,
                    variable.factor = FALSE,
                    value.name = value.name)
  
  # Lots of duplicate table names across g's
  Metadata <- Metadata[TableNo == g]
  
  if (all(.subset2(gmolten, "variable") %chin% .subset2(Metadata, "Long"))) {
    og <- gmolten[Metadata, on = "variable==Long", nomatch=0L]
  } else if (all(.subset2(gmolten, "variable") %chin% .subset2(Metadata, "Short"))) {
    # Want the Long form to be 'variable'
    og <- gmolten[Metadata, on = "variable==Short", nomatch=0L]
    og <- drop_col(og, "variable")
    setnames(og, "Long", "variable")
  } else {
    stop("Unable to decode table names.")
  }
  
  if (is.null(vi)) {
    vi <- range(og[["varI"]])
  }
    
  og %>%
    drop_cols(setdiff(names(Metadata), "varI")) %>%
    .[varI %between% vi] %>%
    extract_Year %>%
    .[]
}
```

```{r extract_Year}
.extract_Year <- function(v) {
  if (all(grepl("^.+_(2006|2011|2016)_Census.*$", v))) {
    out <- as.integer(sub("^.*_(2[0-9]{3})_Census.*$", "\\1", v))
  } else if (all(grepl("^(2006|2011|2016)_Census", v))) {
    out <- as.integer(substr(v, 0, 4))
  } else {
    first_bad <- 
      v[nor(grepl("^(2006|2011|2016)_Census", v),
            grepl("^.+_(2006|2011|2016)_Census.*$", v))] %>%
      head(1)
    print(first_bad)
    stop("Unable to detect census year", call. = FALSE)
  }
  
}

extract_Year <- function(.data) {
  stopifnot("variable" %in% names(.data))
  .data[, Year := .extract_Year(variable)]
}

expect_equal(.extract_Year("Total_persons_2006_Census_Males"), 2006L)
expect_equal(.extract_Year("2006_Census_15_19_years_Married_Females"), 2006L)
```

```{r extract_Sex}
.extract_Sex <- function(v) {
  req_regex <- ".*(Males|Females)$"
  substr(sub(req_regex, "\\1", v), 0, 1)
}

expect_equal(.extract_Sex("Total_persons_2006_Census_Males"), "M")
extract_Sex <- function(.data) {
  req_regex <- ".*(Males|Females)$"
  stopifnot("variable" %in% names(.data),
            all(grepl(req_regex, .data[["variable"]])))
  .data[, Sex := .extract_Sex(variable)]
}
```

```{r grapes-notlike}
`%npin%` <- function(x, y) {
  !grepl(y, x)
}
```

```{r extract_Age}
.extract_Age <- function(v, orderedFactor = TRUE) {
  out <-
    if_else(grepl("^.*Census_[0-9]{1,2}_[0-9]{1,2}_years.*", v),
            sub("^.*Census_([0-9]{1,2})_([0-9]{1,2})_years.*$", "\\1-\\2", v),
            if_else(grepl("years_and_over", v),
                    sub("^.*[^0-9]([0-9]+)_years_and_over.*$", "\\1+", v),
                    if_else(grepl("^.*Age_(?:group(?:_of_parent)?|years)_([0-9]{1,2})_([0-9]{1,2})_years.*", v),
                            sub("^.*Age_(?:group(?:_of_parent)?|years)_([0-9]{1,2})_([0-9]{1,2})_years.*",
                                "\\1-\\2",
                                v),
                                if_else(grepl("_[0-9]{1,2}_[0-9]{1,2}_years$", v),
                                        sub("^.*([0-9]{1,2})_([0-9]{1,2})_years$", "\\1-\\2", v),
                                        v))))
  if (any(grepl("_", out))) {
    stop("\n\t", paste0(head(unique(grep("_", out, value = TRUE))), collapse = "\n\t"), " present.")
  }
            
  if (orderedFactor) {
    out <- factor(out, levels = unique(out), ordered = TRUE)
  }
  out
}
expect_equal(.extract_Age("Age_group_85_years_and_over_2006_Census_Males", FALSE), "85+")
expect_equal(.extract_Age("2016_Census_80_84_years_Never_married_Females", FALSE), "80-84")
expect_equal(.extract_Age("2006_Census_Buddhism_0_14_years", FALSE), "0-14")
expect_equal(.extract_Age("Age_group_0_4_years_2006_Census_Persons", FALSE), "0-4")
expect_equal(.extract_Age("2006_Census_Age_group_of_parent_15_19_years_Number_of_children_ever_born_No_children", FALSE), "15-19")

local({
  input <- c("Age_group_0_4_years_2006_Census_Persons",
             "Age_group_5_14_years_2016_Census_Persons",
             "Age_group_35_44_years_2011_Census_Persons",
             "Age_group_55_64_years_2011_Census_Persons",
             "Age_group_85_years_and_over_2006_Census_Persons")
  output <- .extract_Age(input) 
  
  # i.e. ascending order, not 
  expect_false(is.unsorted(output))
})

extract_Age <- function(.data) {
  .data[, Age := .extract_Age(variable)]
}
```

```{r extract_CountryOfBirth}
extract_CountryOfBirth <- function(DT) {
  DT %>%
    # Set not stated -> NA
    .[variable %npin% "Country_of_birth_not_stated",
      CountryOfBirth := sub("^(.*)_(2006|2011|2016)_Census_(?:Persons|Males|Females)$",
                            "\\1",
                            variable)] %>%
    .[CountryOfBirth == "The_Former_Yugoslav_Rebublic_of_Macedonia",
      CountryOfBirth := "The former Yugoslav Republic of Macedonia"] %>%
    .[CountryOfBirth == "Korea_Republic_of_South",
      CountryOfBirth := "South Korea"] %>%
    .[CountryOfBirth == "United_Kingdom_Channel_Islands_and_Isle_of_Man",
      CountryOfBirth := "United Kingdom"] %>%
    .[CountryOfBirth == "United_States_of_America",
      CountryOfBirth := "United States"] %>%
    .[CountryOfBirth == "Hong_Kong_SAR_of_China",
      CountryOfBirth := "Hong Kong"] %>%
    .[CountryOfBirth == "Hong_Kong_SAR_of_China",
      CountryOfBirth := "Hong Kong"] %>%
    .[CountryOfBirth == "Born_elsewhere",
      CountryOfBirth := "Other"] %>%
    .[, CountryOfBirth := gsub("_", " ", CountryOfBirth)]
}
```




```{r Mop}
Mop <- function(DT, value.name = "persons", suborder = NULL) {
  # Check if any variables have already been used.
  # If so, stop; else, add to varIused
  varIBeingUsed <- .subset2(DT, "varI")
  stopifnot("varI" %in% names(DT),
            is.null(varIused) || !any(varIBeingUsed %in% varIused))
  drop_col(DT, "varI")
  
  stopifnot(value.name %in% names(DT),
            "Year" %in% names(DT),
            # Should be Completed
            'MaxSchooling' %notin% names(DT))
  
  # Check for no duplicates, except for value.name
  if (anyDuplicated(DT, by = setdiff(names(DT), c(value.name, "variable")))) {
    print(duplicated_rows(DT, by = setdiff(names(DT), c(value.name, "variable"))))
    stop("Duplicated rows.")
  }
  
  # Are any columns constant?
  uv <- vapply(DT, uniqueN, integer(1))
  if (any(uv == 1)) {
    print(names(uv)[uv == 1])
    stop("Constant columns in DT.")
  }
  
  out <- 
    DT %>%
    drop_col("variable") %>%
    setcolorder(sort(names(.))) %>%
    set_cols_first(c(Region_key, "Year")) %>%
    setorderv(setdiff(names(.), value.name)) %>%
    set_cols_last(value.name) %>%
    .[]
  
  if ("CountryOfBirth" %in% names(DT)) {
    out[CountryOfBirth %pin% "Born elsewhere", CountryOfBirth := "(Born elsewhere)"]
  }
  
  for (j in names(DT)) {
   out[out[[j]] == "Other", (j) := "(Other)"]
  }
  
  apparent_population <- 
      out[, list(ApparentPopulation = sum(eval(parse(text = value.name)))), keyby = "Year"]
    
  permitted_error <- switch(Region,
                            "SA1" = 1.5e6,
                            0.5e6)
  
  expected_population <-
    fread("data-raw/data/AUST/2016Census_T01_AUS.csv",
          select = c("Tot_persons_C06_P", "Tot_persons_C11_P", "Tot_persons_C16_P")) %>%
    melt(measure.vars = names(.), value.name = "ExpectedPopulation") %>%
    .[, "Year" := 2000L + as.integer(sub("^Tot_persons_C(06|11|16)_P$", "\\1", variable))] %>%
    setkeyv("Year") %>%
    .[]
  
  pop_diff_by_Year <- 
    apparent_population[expected_population, on = "Year"] %>%
    .[, difference := ApparentPopulation - ExpectedPopulation]
  
  differences <- .subset2(pop_diff_by_Year, "difference")
  
  switch(
    value.name,
    "persons" = {
      if (AND(!any(c("SpeaksEnglishOnly", 
                     "BornAust",
                     "MaritalStatus",
                     "MaxSchoolingCompleted",
                     "OnlyEnglishSpokenHome") %in% names(DT)),
              any(abs(differences) > permitted_error))) {
        
        i_first_bad <- which(abs(differences) > permitted_error)[1]
        
        first_bad <-
          pop_diff_by_Year[i_first_bad] %>%
          .subset2("difference")
        
        Yr_first_bad <-
          switch(i_first_bad,
                 2006,
                 2011,
                 2016)
        
        text_apparent_population <-
          apparent_population[i_first_bad] %>%
          .subset2("ApparentPopulation") %>%
          prettyNum(big.mark = ",")
        
        
        if (first_bad < 0) {
          stop("Population undercounted in ", Yr_first_bad, ":\n\t",
               text_apparent_population, "\n\t",
               " (e = ", prettyNum(first_bad, big.mark = ","), ")",
               "\nShould you have used a different value.name?")
        } else {
          stop("Apparent population too high: ", text_apparent_population,
               " (e = ", prettyNum(first_bad, big.mark = ","), ")")
        }
      }
    },
    
    
    "occupied_private_dwellings" = {
      # freadG(15) %$% sum(C16_T_T + C06_T_T + C11_T_T)
      exp_tot_dwellings <- 23190507
      
      tot_dwellings <- sum(out[["occupied_private_dwellings"]])
      if (abs(tot_dwellings - exp_tot_dwellings) / exp_tot_dwellings > 0.05) {
        stop("Dwellings under or overcounted:\n",
             "\t",
             "Expected:\t", prettyNum(exp_tot_dwellings, big.mark = ","),
             "\n\t",
             "Result:  \t",  prettyNum(tot_dwellings, big.mark = ","),
             "\n")
      }
    })
  
  # Check for no duplicates, except for value.name
  if (anyDuplicated(out, by = setdiff(names(out), value.name))) {
    print(duplicated_rows(out, by = setdiff(names(out), value.name)))
    stop("Duplicated rows.")
  }
  if (!is.null(suborder)) {
    set_colsuborder(DT, suborder)
    setorderv(DT, setdiff(names(out), value.name))
  }

  out_noms <- names(out)
  
  object_name <- 
    paste0(Region,
           "__",
           paste0(setdiff(out_noms, c(Region_key, "persons")),
                  collapse = "_"))
  
  if (object_name %in% ls(envir = .GlobalEnv)) {
    stop("`", object_name, "` already defined.")
  }
  
  decoder <- 
    switch(Region,
           "SA2" = SA16_decoder[ASGS_Structure == Region,
                                .(SA2_MAIN16 = Census_Code_2016,
                                  SA2_NAME16 = Census_Name_2016)],
           "SA3" = SA16_decoder[ASGS_Structure == Region,
                                .(SA3_MAIN16 = Census_Code_2016,
                                  SA3_NAME16 = Census_Name_2016)],
           "SA4" = SA16_decoder[ASGS_Structure == Region,
                                .(SA4_MAIN16 = Census_Code_2016,
                                  SA4_NAME16 = Census_Name_2016)],
           "STE" = SA16_decoder[ASGS_Structure == Region,
                                .(STE_MAIN16 = Census_Code_2016,
                                  STE_NAME16 = Census_Name_2016)],
           "LGA" = {
             NonABS_decoder[ASGS_Structure == Region,
                            .(Census_Code_2016, LGA_NAME16 = Census_Name_2016)]
           },
           "CED" = {
             NonABS_decoder[ASGS_Structure == Region,
                            .(Census_Code_2016, CED_NAME16 = Census_Name_2016)]
           },
           "SED" = {
             NonABS_decoder[ASGS_Structure == Region,
                            .(Census_Code_2016, SED_NAME16 = Census_Name_2016)]
           },
           "SSC" = {
             NonABS_decoder[ASGS_Structure == Region,
                            .(Census_Code_2016, SSC_NAME16 = Census_Name_2016)]
           },
           NULL) %>%
    unique %>%
    setnames(1, Region_key)
  
  decoded_out <- decoder[out, on = Region_key]
  decoded_out[, (Region_key) := NULL]
  
  if (!anyDuplicated(decoded_out, by = setdiff(names(decoded_out), value.name))) {
    out <- decoded_out 
  } else {
    cat("\n\n\n\n\n")
    print(duplicated_rows(decoded_out, by = setdiff(names(decoded_out), value.name)))
    cat("\n\n\n\n\n")
  }
  
  assign(object_name, out, envir = .GlobalEnv)
  # Provided we have reached here, we can now modify varIused
  varIused <<- sort(c(varIused, unique(varIBeingUsed)))
  decoded_out[]
}
```

```{r varIused}
varIused <- NULL
```

## G01

### Persons

```{r }
freadT(1, c(1, 9), "persons") %>%
  .[variable %pin% "Persons$"] %>%
  Mop
```

### Persons by gender

```{r}
freadT(1, c(1, 9), "persons") %>%
  .[variable %npin% "Persons$"] %>%
  extract_Sex %>%
  Mop
```

### Persons by age

```{r}
freadT(1, c(10, 108), "persons") %>%
  .[variable %pin% "Persons$"] %>%
  extract_Age %>%
  Mop
```


### Persons by age by sex

```{r}
freadT(1, c(10, 108), "persons") %>%
  .[variable %npin% "Persons$"] %>%
  extract_Sex %>%
  extract_Age %>%
  Mop
```


### Overseas visitors

```{r}
freadT(1, c(109, 117), "overseas_visitors") %>%
  .[variable %pin% "Persons$"] %>%
  Mop(value.name = "overseas_visitors")
```


### Overseas visitors by Sex

```{r}
freadT(1, c(109, 117), "overseas_visitors") %>%
  .[variable %npin% "Persons$"] %>%
  extract_Sex %>%
  Mop(value.name = "overseas_visitors")
```


### ATSI 

```{r}
provide_complementary_observation <- function(.data, vars = "Year") {
  tempDT <- 
    get(paste0(Region, "__", paste0(vars, collapse = "_"))) %>%
    .[SA16_decoder[ASGS_Structure == Region],
      on = c(paste0(names(.)[1], "==Census_Name_2016")),
      nomatch=0L] %>%
    setnames("Census_Code_2016", Region_key)
  
  
  .data %>%
    .[, .(tot_in_persons = sum(persons)), keyby = c(Region_key, vars)] %>%
    .[tempDT, on = c(Region_key, vars)] %>%
    .[, persons := persons - tot_in_persons] %>%
    .[, variable := "Other"] %>%
    .[, .SD, .SDcols = c(Region_key, vars, "variable", "persons")] %>%
    rbind(.data, use.names = TRUE, fill = TRUE)
}


freadT(1, c(118, 144)) %>%
  .[variable %pin% "Persons$"] %>%
  provide_complementary_observation %>%
  .[, Aboriginal := FALSE] %>%
  .[, TorresStraitIslander := FALSE] %>%
  .[variable %pin% "persons_Aboriginal", Aboriginal := TRUE] %>%
  .[variable %pin% "persons_Torres_Strait", TorresStraitIslander := TRUE] %>%
  .[variable %pin% "Both", c("Aboriginal", "TorresStraitIslander") := TRUE] %>%
  Mop
  
```

```{r}
freadT(1, c(118, 144)) %>%
  .[variable %npin% "Persons$"] %>%
  extract_Sex %>%
  provide_complementary_observation(vars = c("Year", "Sex")) %>%
  
  .[, Aboriginal := FALSE] %>%
  .[, TorresStraitIslander := FALSE] %>%
  .[variable %pin% "persons_Aboriginal", Aboriginal := TRUE] %>%
  .[variable %pin% "persons_Torres_Strait", TorresStraitIslander := TRUE] %>%
  .[variable %pin% "Both", c("Aboriginal", "TorresStraitIslander") := TRUE] %>%
  Mop
```

```{r}
varIused <- c(varIused, 145:153)
```

```{r}
freadT(1, c(154, 171)) %>%
  .[variable %pin% "Persons$"] %>%
  .[, BornAust := grepl("Birthplace_Australia", variable)] %>%
  Mop
```

```{r}
freadT(1, c(154, 171)) %>%
  .[variable %npin% "Persons$"] %>%
  .[, BornAust := grepl("Birthplace_Australia", variable)] %>%
  extract_Sex %>%
  Mop
```

```{r}
freadT(1, c(172, 189)) %>%
  .[variable %pin% "Persons$"] %>%
  .[, SpeaksEnglishOnly := grepl("English_only", variable)] %>%
  Mop
```

```{r}
freadT(1, c(172, 189)) %>%
  .[variable %npin% "Persons$"] %>%
  .[, SpeaksEnglishOnly := grepl("English_only", variable)] %>%
  extract_Sex %>%
  Mop
```

```{r}
freadT(1, c(190, 199)) %>%
  .[variable %pin% "Persons$"] %>%
  provide_complementary_observation %>%
  .[, AustCitizen := variable != "Other"] %>%
  Mop
```


```{r}
freadT(1, c(190, 199)) %>%
  .[variable %npin% "Persons$"] %>%
  extract_Sex %>%
  provide_complementary_observation %>%
  .[, AustCitizen := variable != "Other"] %>%
  Mop
```

```{r melt_using_suffix}
melt_using_suffix <- function(DT, suffix, suffix_is = "Year", id.cols = Region_key) {
   prefixes <- sub(suffix, "", setdiff(names(DT), Region_key))
   suffixes <- sub(paste0("^.*", suffix), "\\1", setdiff(names(DT), Region_key))
   
   decode_suffix <- data.table(temp = seq_along(unique(suffixes)),
                               new = unique(suffixes)) %>%
     .[, temp := as.character(temp)] %>%
     setnames(c("temp", "new"), c("_temp", suffix_is))
   
   melt.data.table(DT, 
                   id.vars = id.cols,
                   measure.vars = patterns(unique(prefixes)),
                   value.name = unique(prefixes),
                   variable.name = "_temp",
                   variable.factor = FALSE,
                   verbose = TRUE) %>%
     .[decode_suffix, on = "_temp"] %>%
     .[, "_temp" := NULL] %>%
     set_cols_first(c(Region_key, suffix_is)) %>%
     .[]
}
```

```{r Mop_multiple}
Mop_multiple <- function(DT) {
  DTnoms <- copy(names(DT))
  for (nom in DTnoms) {
    if (!(nom %chin% c(Region_key, "Year"))) {
      nom_ <-
        gsub("^([A-Z])", "\\L\\1\\E",
             x = gsub("_([A-za-z])", "\\U\\1\\E",
                      nom,
                      perl = TRUE),
             perl = TRUE)
      
      object_name <- 
        paste0(Region,
               "__",
               "Year",
               "_",
               nom_)
      
      assign(object_name,
             value = DT[, .SD, .SDcols = c(Region_key, "Year", nom)],
             envir = .GlobalEnv)
    }
  }
}
```


## T02
```{r}
freadG(2)[] %>%
  melt_using_suffix("_Census_year_(2006|2011|2016)") %>%
  Mop_multiple
```

## T03

```{r}
freadT(3, vi = c(223, 1104))[] %>%
  .[variable %pin% "years_[0-9]{1,2}_(2006|2011|2016)"] %>%
  .[variable %pin% "Persons$"] %>%
  .[, Age.int := as.integer(sub("^.*years_([0-9]{1,2})_(2006|2011|2016).*$", "\\1", variable))] %>%
  provide_complementary_observation %>%
  Mop
```

```{r}
freadT(3, vi = c(223, 1104))[] %>%
  .[variable %pin% "years_[0-9]{1,2}_(2006|2011|2016)"] %>%
  .[variable %npin% "Persons$"] %>%
  .[, Age.int := as.integer(sub("^.*years_([0-9]{1,2})_(2006|2011|2016).*$", "\\1", variable))] %>%
  extract_Sex %>%
  provide_complementary_observation %>%
  Mop
```


### Grouped age

```{r}
# Already used
varIused <- unique(sort(c(varIused, seq(223, 1104))))
```

```{r}
freadT(4, c(1114, 1737)) %>%
  .[variable %npin% "Persons$"] %>%
  .[variable %npin% "Total"] %>%
  .[or(grepl("[0-9]{1,2}_[0-9]{1,2}_years", variable),
       grepl("85_years", variable))] %>%
  .[, MaritalStatus := sub("^.*years(?:_and_over)?_([A-Z].+)_(Males|Females)$", "\\1", variable)] %>%
  .[MaritalStatus == "Never_married", MaritalStatus := "Never married"] %>%
  extract_Age %>%
  extract_Sex %>%
  Mop
```

```{r}
freadT(7, vi = c(2710, 3141), value.name = "females") %>%
  .[!grepl("Total", variable)] %>%
  extract_Age %>%
  .[variable %pin% "No_child",    ChildrenEverBorn := 0L] %>%
  .[variable %pin% "One_child",   ChildrenEverBorn := 1L] %>%
  .[variable %pin% "Two_child",   ChildrenEverBorn := 2L] %>%
  .[variable %pin% "Three_child", ChildrenEverBorn := 3L] %>%
  .[variable %pin% "Four_child",  ChildrenEverBorn := 4L] %>%
  .[variable %pin% "Five_child",  ChildrenEverBorn := 5L] %>%
  .[variable %pin% "Six_or_more_child", ChildrenEverBorn := 6L] %>%
  Mop(value.name = "females")
```

```{r}
freadT(8, c(3142, 3483)) %>%
  .[variable %pin% "Persons$"] %>%
  .[variable %npin% "Total"] %>%
  extract_CountryOfBirth %>%
  Mop
```

```{r}
freadT(8, c(3142, 3483)) %>%
  .[variable %npin% "Persons$"] %>%
  .[variable %npin% "Total"] %>%
  extract_CountryOfBirth %>%
  extract_Sex %>%
  Mop
```

## Ancestory

```{r}
freadT(10) %>%
  .[!grepl("Total", variable)] %>%
  .[variable %pin% "Persons$"] %>%
  .[grepl("Speaks_English_only", variable),
    LanguageSpoken := "English"] %>%
  .[variable %pin% "^Speaks_other_language_(.*)_20(06|11|16)_Census_.*$",
    LanguageSpoken := sub("^Speaks_other_language_(.*)_20(06|11|16)_Census_.*$", "\\1", variable)] %>%
  Mop
```


```{r}
freadT(10) %>%
  .[!grepl("Total", variable)] %>%
  .[variable %npin% "Persons$"] %>%
  .[grepl("Speaks_English_only", variable),
    LanguageSpoken := "English"] %>%
  .[variable %pin% "^Speaks_other_language_(.*)_20(06|11|16)_Census_.*$",
    LanguageSpoken := sub("^Speaks_other_language_(.*)_20(06|11|16)_Census_.*$", "\\1", variable)] %>%
  extract_Sex %>%
  Mop
```

```{r}
freadT(11) %>%
  .[!grepl("Total", variable)] %>%
  .[grepl("English_Very_well_or_well", variable), EnglishProficiency := "Speaks English well or very well"] %>%
  .[grepl("English_Not_well", variable), EnglishProficiency := "Speaks English not well or not at all"] %>%
  extract_Age %>%
  .[]

```

```{r}
freadT(12) %>%
  .[!grepl("Total", variable)] %>%
  extract_Age %>%
  .[, Religion := gsub("^.*Census_([^0-9]+)_[0-9].*$", "\\1", variable)] %>%
  .[Religion == "Secular_Beliefs_and_Other_Spiritual_Beliefs_and_No_Religious_Affiliation",
    Religion := "No religion"] %>%
  .[Religion == "Religious_affiliation_not_stated",
    Religion := NA_character_] %>%
  .[Religion %pin% "Christ", Denomination := gsub("^Christ[a-z]+y_", "", Religion)] %>%
  .[Religion %pin% "Christ", Religion := "Christianity"] %>%
  .[Religion %enotin% c("Christianity", "Buddhism", "Hinduism", "Judaism", "Islam", "No religion"),
    Religion := "(Other)"] %>%
  .[] %>%
  .[variable %pin% "Presbyterian",
   Denomination := "Presbyterian Reformed"] %>%
  .[variable %pin% "Eastrn.Orthdox",
    Denomination := "Eastern Orthodox"] %>%
  .[variable %pin% "Orintal_Orthdx",
    Denomination := "Oriental Orthodox"] %>%
  .[variable %pin% "Sevnth.dy",
    Denomination := "Seventh Day Adventist"] %>%
  .[variable %pin% "Othr_Protestnt",
    Denomination := "Protestant (Other)"] %>%
  .[variable %pin% "Jeh.*v.*ahs.*Witn.*s.*es",
    Denomination := "Jehovah's Witnesses"] %>%
  .[variable %pin% "Oth.?r_Christian",
    Denomination := "(Other)"] %>%
  .[variable %pin% "Sikhism",
    Denomination := "Sikhism"] %>%
  .[variable %pin% "Aust.*Abor.*Trad.*Rel",
    Denomination := "Australian Aboriginal Traditional"] %>%
  .[variable %pin% "Other_Religions_Other_Religious_Groups",
    Denomination := "(Other)"] %>%
  .[variable %pin% "SB_OSB_NRA_SB",
    Denomination := "Secular beliefs"] %>%
  .[variable %pin% "SB_OSB_NRA_OSB",
    Denomination := "Other spiritual beliefs"] %>%
  .[, Religion := gsub("_", " ", Religion)] %>%
  .[, Denomination := gsub("_", " ", Denomination)] %>%
  Mop
```

```{r}
freadT(13, value.name = "students") %>%
  .[variable %pin% "Persons$"] %>%
  .[!grepl("^Total", variable)] %>%
  .[if_else(variable %pin% c("^(?:Technical|University)",
                             "^Other_type",
                             "^Infants_Primary",
                             "^Secondary"),
            grepl("Total", variable),
            TRUE)] %>%
  .[variable %pin% "Pre.school",     EduInstitutionType := "Pre-school"] %>%
  .[variable %pin% "Infants.Primary",EduInstitutionType := "Infants/Primary"] %>%
  .[variable %pin% "^Secondary",     EduInstitutionType := "Secondary"] %>%
  .[variable %pin% "^Tec.*Furt",     EduInstitutionType := "Technical or Further Educational Institution"] %>%
  .[variable %pin% "^Uni",           EduInstitutionType := "University or other tertiary"] %>%
  .[variable %pin% "^Oth",           EduInstitutionType := "(Other)"] %>%
  Mop("students")

```

```{r}
freadT(13, value.name = "students") %>%
  .[!(variable %pin% "Persons$")] %>%
  .[!grepl("^Total", variable)] %>%
  .[if_else(variable %pin% c("^(?:Technical|University)",
                             "^Other_type",
                             "^Infants_Primary",
                             "^Secondary"),
            grepl("Total", variable),
            TRUE)] %>%
  .[variable %pin% "Pre.school",     EduInstitutionType := "Pre-school"] %>%
  .[variable %pin% "Infants.Primary",EduInstitutionType := "Infants/Primary"] %>%
  .[variable %pin% "^Secondary",     EduInstitutionType := "Secondary"] %>%
  .[variable %pin% "^Tec.*Furt",     EduInstitutionType := "Technical or Further Educational Institution"] %>%
  .[variable %pin% "^Uni",           EduInstitutionType := "University or other tertiary"] %>%
  .[variable %pin% "^Oth",           EduInstitutionType := "(Other)"] %>%
  .[, EduInstitutionType := factor(EduInstitutionType,
                                   levels = unique(EduInstitutionType),
                                   ordered = TRUE)] %>%
  extract_Sex %>%
  Mop("students")
```

```{extract_FamilyComposition}
.extract_FamilyComposition <- function(v) {
  outputs <- 
    c("Couple family with no children",
      "Couple family with children", 
      "One parent family with children",
      "Other family",
      "Lone-person household", 
      "Group household")
  
  underscores <- gsub("[^A-Za-z]", "_",
                      gsub("One parent family with children",
                           "One parent family", 
                           outputs,
                           fixed = TRUE))
  
  regex <-
    paste0("(?:",
           paste0(underscores, 
                  collapse = ")|(?:"),
           ")")
  
  underscore_out <- 
    sub(paste0("^.*?(", regex, ").*?$"), 
        "\\1",
        v,
        perl = TRUE)
  
  outputs[match(underscore_out, underscores)]
}

extract_FamilyComposition <- function(.data) {
  outputs <- 
    c("Couple family with no children",
      "Couple family with children", 
      "One parent family with children",
      "Other family",
      "Lone-person household", 
      "Group household")
  
  underscores <- gsub("[^A-Za-z]", "_", outputs)
  
  req_regex <-
    paste0("(?:",
           paste0(underscores, 
                  collapse = ")|(?:"),
           ")")
  
  stopifnot("variable" %in% names(.data),
            all(grepl(req_regex, .data[["variable"]])))
  .data[, FamilyComposition := .extract_FamilyComposition(variable)]
  .data
}

expect_equal(.extract_FamilyComposition("2006_Census_Separate_house_Family_households_Couple_family_with_no_children"), 
             "Couple family with no children")
```


```{r}
freadT(14, value.name =  "occupied_private_dwellings") %>%
  .[!(variable %pin% "Total$")] %$%
  .[, isFamily := variable %pin% "Family_households"] %>%
  .[(isFamily),
    FamilyComposition := gsub("_", " ",
                              gsub("^.*Family_households_",
                                   "",
                                   variable))] %>%
  .[not(isFamily),
    FamilyComposition := sub("^.*((?:Lone_person)|(?:Group)|(?:Other)).*$",
                             "\\1",
                             variable)] %>%
  .[, FamilyComposition := gsub("_", " ", FamilyComposition)] %>%
  .[FamilyComposition == "Other", FamilyComposition := "Other family"] %>%
  .[FamilyComposition == "Group", FamilyComposition := "Group household"] %>%
  .[FamilyComposition == "Lone person", FamilyComposition := "Lone-person household"] %>%
  .[]
```

```{r zmatch}
#' @param x Values to be matched against
#' @param y Permitted decoded values. 
#' @param extract1 A regex with a capturing group. The part of \code{x} to be retained.
#' @return For every value in x, the closest match in y.
zmatch <- function(x, y, extract1 = "^(.*)$") {
  x <- sub(extract1, "\\1", x, perl = TRUE)
  Y <- gsub("[^A-Za-z]+", "_", y)
  distance_matrix <-
    adist(x, Y,
          costs = list(deletions = 0.01,
                       substitutions = 0.2))
  
  indexes <- apply(distance_matrix, 1, which.min)
  y[indexes]
}
```

```{r permitted_DwellingStructures}
permitted_DwellingStructures <-
  c(NA_character_,
    "(Other)",
    "Flat/apartment",
    "Semi-detached, row/terrace house, townhouse etc.", 
    "Separate house")
```

```{r test_zmatch}
test_that("zmatch", {
  x0 <- 'Semi_detached_row_or_terrace_house_townhouse_etc_with_Two_or_more_storeys_'
  expect_equal(zmatch(x0, permitted_DwellingStructures), 
               permitted_DwellingStructures[4])
})
```








```{r}
freadT(15, value.name = "occupied_private_dwellings") %>%
  .[variable %pin% paste0("^(20(06|11|16))_Census_",
                          c("Separate_house", 
                            "Semi_detached_row_or_terrace_house_townhouse_etc_with_Total", 
                            "Flat_unit_or_apartment_Total",
                            "Other_dwelling_Total",
                            "Dwelling_structure_not_stated"),
                          "_Total$")] %>%
  .[, DwellingStructure := zmatch(variable, 
                                  permitted_DwellingStructures,
                                  extract1 = "^(?:20(?:06|11|16))_Census_(.*)(?:_Total)?_Total$")] %>% 
  # .[, DwellingStructure := sub("^(?:20(?:06|11|16))_Census_(.*)(?:_Total)?_Total$", "\\1", variable)] %>% 
  .[variable %pin% "Dwelling_structure_not_stated", DwellingStructure := NA_character_] %>%
  .[] %>%
  Mop("occupied_private_dwellings")
```


```{r}
freadT(15, value.name = "occupied_private_dwellings") %>%
  .[variable %pin% paste0("^(20(06|11|16))_Census_",
                          c("Separate_house", 
                            "Semi_detached_row_or_terrace_house_townhouse_etc_with_Total", 
                            "Flat_unit_or_apartment_Total",
                            "Other_dwelling_Total",
                            "Dwelling_structure_not_stated"),
                          "_Number_of_persons_usually_resident")] %>%
  .[, DwellingStructure := zmatch(variable, 
                                  permitted_DwellingStructures,
                                  extract1 = "^(?:20(?:06|11|16))_Census_(.*)(?:_Total)?_Total$")] %>% 
  # .[, DwellingStructure := sub("^(?:20(?:06|11|16))_Census_(.*)(?:_Total)?_Total$", "\\1", variable)] %>% 
  .[variable %pin% "Dwelling_structure_not_stated", DwellingStructure := NA_character_] %>%
  .[] %>%
   .[,
    UsualResidents.min := zmatch(variable, 
                                 c("One", "Two", "Three", "Four", "Five", "Six"),
                                 extract1 = "^.*persons_usually_resident_(.*)$")] %>%
  .[,
    UsualResidents.min := as.integer(match(UsualResidents.min,
                                           table = c("One", "Two", "Three", "Four", "Five", "Six")))] %>%
  Mop("occupied_private_dwellings")
```









